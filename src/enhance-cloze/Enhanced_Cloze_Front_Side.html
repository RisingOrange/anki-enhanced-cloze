<div id="card-body">
    <div id="main-section" class="content">
        <!-- this element is invisible, the purpose of it is to make Anki generate the needed cards
        and to pass the information about which cloze is the main one to the card
        (can be determined by looking at the cloze-id attribute) -->
        <span id="dummy-clozes" style="display: none;">
            {{cloze:Cloze1}}
            {{cloze:Cloze2}}
            {{cloze:Cloze3}}
            {{cloze:Cloze4}}
            {{cloze:Cloze5}}
            {{cloze:Cloze6}}
            {{cloze:Cloze7}}
            {{cloze:Cloze8}}
            {{cloze:Cloze9}}
            {{cloze:Cloze10}}
            {{cloze:Cloze11}}
            {{cloze:Cloze12}}
            {{cloze:Cloze13}}
            {{cloze:Cloze14}}
            {{cloze:Cloze15}}
            {{cloze:Cloze16}}
            {{cloze:Cloze17}}
            {{cloze:Cloze18}}
            {{cloze:Cloze19}}
            {{cloze:Cloze20}}
        </span>
        <span id="data" style="display: none;">
            {{data}}
        </span>
        <!-- this element will contain the actual content - the enhanced clozes -->
        <span id="enhanced-clozes">

        </span>
    </div>
    <br>
    <br>
    <br>

    <span id="content" style="display: none;">{{Content}}</span>


<div>
    <!-- Separation line -->
    {{#Note}}
    <div id="note-section">
        <div id="note-header" class="header header-red" onclick="showNextElement(this)">
            Note
        </div>
        <div id="note" class="content" style="display:none">
            {{Note}}
        </div>
    </div>
    <br> {{/Note}}

    {{#Mnemonics}}
    <div id="mnemonics-section">
        <div id="mnemonics-header" class="header header-green" onclick="showNextElement(this)">
            Mnemonics
        </div>
        <div id="mnemonics" class="content" style="display:none">
            {{Mnemonics}}
        </div>
    </div>
    <br> {{/Mnemonics}}

    {{#Extra}}
    <div id="extra-section">
        <div id="extra-header" class="header header-yellow" onclick="showNextElement(this)">
            Extra
        </div>
        <div id="extra" class="content" style="display:none">
            {{Extra}}
        </div>
    </div>
    <br> {{/Extra}}

    <div id="info-section">
        <div id="info-header" class="header header-blue" onclick="showNextElement(this)">
            Information
        </div>

        <div id="info" class="content" style="display:none">
            <div>
                Deck: {{Deck}}
            </div>

            <br>
            <!-- Separation line -->
            {{#Tags}}
            <div id="tags">
                Tags: {{Tags}}
            </div>
            {{/Tags}}
        </div>
    </div>
    <br>

    <div id="functional-elements">
        <div id="show-one-cloze-left"></div>
        <div id="show-one-cloze-right"></div>
        <div id="no-more-cloze"></div>
        <div id="show-all-pseudo-clozes"></div>
        <div style="display:none">
            {{type:In-use Clozes}}
        </div>
    </div>

</div>

</div>

<script src="_jquery-3.2.1.min.js"></script>
<script src="_jquery.hotkeys.js"></script>
<script src="_jquery.visible.min.js"></script>

<script>
    var dummyClozes = document.getElementById("dummy-clozes").querySelectorAll(":scope > span")
    var genuineClozeIndeces = [...dummyClozes].map(x => Number.parseInt(x.getAttribute("cloze-id").slice(1)))

    document.getElementById("enhanced-clozes").innerHTML = prepareEnhancedClozes(genuineClozeIndeces)

    var indexOfGenuineClozeToShow = 0;
    var genuineClozeTotalNumber = genuineClozeIndeces.length

    // for the preview in the card window

    $(function () {

        // INITIALIZE CLOZES
        //      genuine clozes refer to those belong to current card and need to be answered, e.g. { {c2::abc} } on card2
        //      pseudo clozes refer to the opposite, e.g. { {c1::abc} } and { {c3::abc} } on card2
        $('.genuine-cloze, .pseudo-cloze').each(function (index, elem) {
            toggleCloze(elem, 'hint')
        });

        // SCROLL TO FIRST CLOZE
        if (genuineClozeTotalNumber) {
            scrollToCloze($('.genuine-cloze').first().get(0));
        }

        $(document).keyup(function (event) {
            if (event.which == 73 || event.which == 105){//i
                showOneCloze();
            }
            if (event.which == 188){ //,
                showAllPseudoClozes();
            }
        })

        // SETUP CLOZE CLICK EVENT
        $('.genuine-cloze, .pseudo-cloze').click(function () {
            toggleCloze(this, 'toggle');
        });

        $('#show-one-cloze-left, #show-one-cloze-right').click(function () {
            showOneCloze();
        });

        $('#show-all-pseudo-clozes').click(function () {
            showAllPseudoClozes();
        })

    });

    function prepareEnhancedClozes(genuineClozeIndeces){
        var result = "";
        var i = 0
        
        // the data variable is set by a script tag in the data field of the note
        for(var [part, clozeId] of data["parts"]){
            result += part
            if(i == data["parts"].length - 1) break

            result += genuineClozeIndeces.indexOf(clozeId) != -1 ? "genuine-cloze" : "pseudo-cloze"
            i += 1
        }
        return result
    }

    function scrollToCloze(elem) {
        $('html, body').animate({
            scrollTop: $(elem).offset().top - 60
        }, 500);
    }

    function showOneCloze() {
        //alert("indexOfGenuineClozeToShow is "+indexOfGenuineClozeToShow+" while genuineClozeTotalNumber is "+genuineClozeTotalNumber );
        if (indexOfGenuineClozeToShow >= genuineClozeTotalNumber) {
            $('#no-more-cloze').animate({
                display: "toggle",
            }, 500);
        } else {
            //alert("Thus there remains genuine cloze");
            $('.genuine-cloze[index=' + indexOfGenuineClozeToShow + ']').each(function (index, elem) {
                //alert("We loop over index"+index);
                len = $(elem).parents('#note:hidden').length
                //alert("$(elem).parents('#note:hidden').length is "+len);
                if (len) {
                    //alert("Thus show");
                    $("#note").show(0);
                } else {
                    //alert("Thus don't show");
                    if (!$(elem).is(":visible")) {
                        //alert("Elem is not visible");
                        scrollToCloze(elem);
                    } else {
                        //alert("Elem is visible");
                        toggleCloze(elem, 'answer');
                        if (!$(elem).is(":visible")) {
                            //alert("Elem is not visible (second time)");
                            scrollToCloze(elem);
                        } else {
                            //alert("Elem is visible (second time)");
                        }
                        $(elem).hide(0);
                        $(elem).fadeIn(500);
                        indexOfGenuineClozeToShow++;
                    }
                }
            })
        }
        //alert("");
    }

    function showAllPseudoClozes() {
        $('.pseudo-cloze').each(function (index, elem) {
            toggleCloze(elem, 'answer');
        })
    }

    function toggleCloze(elem, displayOption) {
        var answer = '', hint = '';
        var index = $(elem).attr('index');

        answer = data["answers"][index]
        hint = data["hints"][index]

        hint = '&nbsp;&nbsp;[&nbsp;&nbsp;' + hint + '&nbsp;&nbsp;]&nbsp;&nbsp;';

        if (displayOption == 'answer') {
            $(elem).attr('show-state', 'answer');
            $(elem).html(answer);
        } else if (displayOption == 'hint') {
            $(elem).attr('show-state', 'hint');
            $(elem).html(hint);
        } else if (displayOption == 'toggle') {
            if ($(elem).attr('show-state') == 'hint') {
                $(elem).attr('show-state', 'answer');
                $(elem).html(answer);
            } else {
                $(elem).attr('show-state', 'hint');
                $(elem).html(hint);
            };
        };
    }

    function showNextElement(elem) {
        $(elem).next().show(0);
    };
</script>
