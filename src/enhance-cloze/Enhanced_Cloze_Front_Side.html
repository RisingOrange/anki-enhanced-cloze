<div id="card-body">
    <div id="main-section" class="content">
        <!-- this element is invisible, the purpose of it is to make Anki generate the needed cards
        and to pass the information about which cloze is the main one to the card
        (can be determined by looking at the cloze-id attribute) -->
        <span id="dummy-clozes" style="display: none;">
            {{cloze:Cloze1}}
            {{cloze:Cloze2}}
            {{cloze:Cloze3}}
            {{cloze:Cloze4}}
            {{cloze:Cloze5}}
            {{cloze:Cloze6}}
            {{cloze:Cloze7}}
            {{cloze:Cloze8}}
            {{cloze:Cloze9}}
            {{cloze:Cloze10}}
            {{cloze:Cloze11}}
            {{cloze:Cloze12}}
            {{cloze:Cloze13}}
            {{cloze:Cloze14}}
            {{cloze:Cloze15}}
            {{cloze:Cloze16}}
            {{cloze:Cloze17}}
            {{cloze:Cloze18}}
            {{cloze:Cloze19}}
            {{cloze:Cloze20}}
            {{cloze:Cloze21}}
            {{cloze:Cloze22}}
            {{cloze:Cloze23}}
            {{cloze:Cloze24}}
            {{cloze:Cloze25}}
            {{cloze:Cloze26}}
            {{cloze:Cloze27}}
            {{cloze:Cloze28}}
            {{cloze:Cloze29}}
            {{cloze:Cloze30}}
            {{cloze:Cloze31}}
            {{cloze:Cloze32}}
            {{cloze:Cloze33}}
            {{cloze:Cloze34}}
            {{cloze:Cloze35}}
            {{cloze:Cloze36}}
            {{cloze:Cloze37}}
            {{cloze:Cloze38}}
            {{cloze:Cloze39}}
            {{cloze:Cloze40}}
            {{cloze:Cloze41}}
            {{cloze:Cloze42}}
            {{cloze:Cloze43}}
            {{cloze:Cloze44}}
            {{cloze:Cloze45}}
            {{cloze:Cloze46}}
            {{cloze:Cloze47}}
            {{cloze:Cloze48}}
            {{cloze:Cloze49}}
            {{cloze:Cloze50}}
        </span>
        <span id="data" style="display: none;">
            {{data}}
        </span>
        <!-- this element will contain the actual content - the enhanced clozes -->
        <span id="enhanced-clozes">
            This is an example <span class="genuine-cloze" index="0" show-state="hint"cloze-id="c1">&nbsp;&nbsp;[&nbsp;&nbsp;&nbsp;&nbsp;]&nbsp;&nbsp;</span>
        </span>
    </div>
    <br>
    <br>
    <hr>
    <br>
    <p class="" style="margin: 5.5px;"></p>


<div>
    <!-- Separation line -->
    {{#Note}}
    <div id="note-section">
        <div id="note-header" class="header header-red" onclick="showNextElement(this)">
            Note
        </div>
        <div id="note" class="content" style="display:none">
            {{Note}}
        </div>
    </div>
    <br> 
    <p class="" style="margin: 5.5px;"></p>
    {{/Note}}

    {{#Mnemonics}}
    <div id="mnemonics-section">
        <div id="mnemonics-header" class="header header-green" onclick="showNextElement(this)">
            Mnemonics
        </div>
        <div id="mnemonics" class="content" style="display:none">
            {{Mnemonics}}
        </div>
    </div>
    <br> 
    <p class="" style="margin: 5.5px;"></p>
    {{/Mnemonics}}

    {{#Extra}}
    <div id="extra-section">
        <div id="extra-header" class="header header-yellow" onclick="showNextElement(this)">
            Extra
        </div>
        <div id="extra" class="content" style="display:none">
            {{Extra}}
        </div>
    </div>
    <br> 
    <p class="" style="margin: 5.5px;"></p>
    {{/Extra}}

    <div id="info-section">
        <div id="info-header" class="header header-blue" onclick="showNextElement(this)">
            Information
        </div>

        <div id="info" class="content" style="display:none">
            <div>
                <b>Deck</b>: <br><i>{{Deck}}</i>
            </div>

            <br>
            <!-- Separation line -->
            {{#Tags}}
            <div id="tags">
                <b>Tags</b>: <br><i>{{Tags}}</i>
            </div>
            {{/Tags}}
        </div>
    </div>
    <br>

    <div id="functional-elements">
        <div id="show-one-cloze-left"></div>
        <div id="show-one-cloze-right"></div>
        <div id="no-more-cloze"></div>
        <div id="show-all-pseudo-clozes"></div>
    </div>

</div>

</div>

<script src="_jquery-3.2.1.min.js"></script> 
<script src="_jquery.hotkeys.js"></script>
<script src="_jquery.visible.min.js"></script>
<!-- Do not change this part of the template! Changes will be overwritten by the add-on -->

<script>
    equals = (a, b) => {
        if (a === b) return true;
        if (a instanceof Date && b instanceof Date)
            return a.getTime() === b.getTime();
        if (!a || !b || (typeof a !== 'object' && typeof b !== 'object'))
            return a === b;
        if (a.prototype !== b.prototype) return false;
        let keys = Object.keys(a);
        if (keys.length !== Object.keys(b).length) return false;
        return keys.every(k => equals(a[k], b[k]));
    };

    var dummyClozes = document.getElementById("dummy-clozes").querySelectorAll(":scope > span")
    var clozesExist = dummyClozes[0] && dummyClozes[0].hasAttribute("cloze-id")
    if (clozesExist) {
        if (!equals(data['parts'], [["", null]])){
            // normal mode
            var genuineClozeIndeces = [...dummyClozes].map(x => Number.parseInt(x.getAttribute("cloze-id").slice(1)))

            document.getElementById("enhanced-clozes").innerHTML = prepareEnhancedClozes(genuineClozeIndeces)
            var curShowIdx = 0;
        } else {
            // card designer mode
            var data = {"answers": ["cloze"], "hints": [""]} 
        }
    } else {
        // no cloze mode
        document.getElementById("enhanced-clozes").innerHTML = prepareEnhancedClozes()
    }

    $(function () {

        // INITIALIZE CLOZES
        //      genuine clozes refer to those belong to current card and need to be answered, e.g. { {c2::abc} } on card2
        //      pseudo clozes refer to the opposite, e.g. { {c1::abc} } and { {c3::abc} } on card2
        $('.genuine-cloze, .pseudo-cloze').each(function (index, elem) {
            toggleCloze(elem, 'hint')
        });

        // SCROLL TO FIRST CLOZE
        if ($('.genuine-cloze').length != 0) {
            scrollToCloze($('.genuine-cloze').first().get(0));
        }

        $(document).keyup(function (event) {
            if (event.which == 73){
                showOneCloze();
            }
            if (event.which == 188){
                showAllPseudoClozes();
            }
        })

        // SETUP CLOZE CLICK EVENT
        $('.genuine-cloze, .pseudo-cloze').click(function () {
            toggleCloze(this, 'toggle');
        });

        $('#show-one-cloze-left, #show-one-cloze-right').click(function () {
            showOneCloze();
        });

        $('#show-all-pseudo-clozes').click(function () {
            showAllPseudoClozes();
        })

    });

    function prepareEnhancedClozes(genuineClozeIndeces){
        var result = "";
        var i = 0
        
        // the data variable is set by a script tag in the data field of the note
        for(var [part, clozeId] of data["parts"]){
            result += part
            if(i == data["parts"].length - 1) break

            result += genuineClozeIndeces.indexOf(clozeId) != -1 ? "genuine-cloze" : "pseudo-cloze"
            i += 1
        }
        return result
    }

    function scrollToCloze(elem) {
        $('html, body').animate({
            scrollTop: $(elem).offset().top - 60
        }, 500);
    }

    function showOneCloze() {
        gClozeExists = (index) => $('.genuine-cloze[index=' + index + ']').length != 0
        pClozeExists = (index) => $('.pseudo-cloze[index=' + index + ']').length != 0
           
        while(pClozeExists(curShowIdx)){
                curShowIdx += 1
        }
        if(!gClozeExists(curShowIdx)) {
            $('#no-more-cloze').animate({
                display: "toggle",
            }, 500);
            return
        } 

        $('.genuine-cloze[index=' + curShowIdx + ']').each(function (index, elem) {
            if (!$(elem).is(":visible")) {
                scrollToCloze(elem);
            } else {
                toggleCloze(elem, 'answer');
                if (!$(elem).is(":visible")) {
                    scrollToCloze(elem);
                } else {
                }
                $(elem).hide(0);
                $(elem).fadeIn(500);
                curShowIdx++;
            }
        })
    }

    function showAllPseudoClozes() {
        $('.pseudo-cloze').each(function (index, elem) {
            toggleCloze(elem, 'answer');
        })
    }

    function toggleCloze(elem, displayOption) {
        var answer = '', hint = '';
        var index = $(elem).attr('index');

        answer = data["answers"][index]
        hint = data["hints"][index]

        if(answer.startsWith('#')){
            answer = answer.slice(1)

            if($(elem).attr('class') == 'pseudo-cloze'){
                $(elem).attr('show-state', 'answer');
                $(elem).html(answer);
                return
            } 
        }

        hint = '&nbsp;&nbsp;[&nbsp;&nbsp;' + hint + '&nbsp;&nbsp;]&nbsp;&nbsp;';

        if (displayOption == 'answer') {
            $(elem).attr('show-state', 'answer');
            $(elem).html(answer);
        } else if (displayOption == 'hint') {
            $(elem).attr('show-state', 'hint');
            $(elem).html(hint);
        } else if (displayOption == 'toggle') {
            if ($(elem).attr('show-state') == 'hint') {
                $(elem).attr('show-state', 'answer');
                $(elem).html(answer);
            } else {
                $(elem).attr('show-state', 'hint');
                $(elem).html(hint);
            };
        };
    }

    function showNextElement(elem) {
        $(elem).next().show(0);
    };
</script>